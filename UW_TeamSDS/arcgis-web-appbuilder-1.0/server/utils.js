function saveBase64ToImgSync(e,r){if(!/^data:image\/.*;base64,/.test(r))throw Error("Bad base64 code format");var i=r.match(/^data:image\/(.*);base64,/)[1],t=r.replace(/^data:image\/.*;base64,/,""),n=e.lastIndexOf(".");return e=e.substr(0,n+1)+i,fs.writeFileSync(e,t,"base64"),e}function visitObject(e,r){for(var i in e)e[i]instanceof Array?visitArray(e[i],r):"object"==typeof e[i]?visitObject(e[i],r):r(e,i)}function visitArray(e,r){e.forEach(function(i,t){i instanceof Array?visitArray(i,r):"object"==typeof i?visitObject(i,r):r(e,t)})}function visitFolderFiles(e,r){var i=fs.readdirSync(e);i.forEach(function(i){var t=path.normalize(e+"/"+i);fs.statSync(t).isDirectory()?r(t,i,!0)||visitFolderFiles(t,r):r(t,i,!1)})}function visitSubFolders(e,r){var i=fs.readdirSync(e);i.forEach(function(i){var t=path.normalize(e+"/"+i);fs.statSync(t).isDirectory()&&(r(t,i,fs.readdirSync(t))||visitSubFolders(t,r))})}function findMaxFileIndexInFolder(e,r){var i=fs.readdirSync(e),t=-1;return i.forEach(function(e){if(e.substring(0,e.lastIndexOf("."))===r)t=0;else if(e.startWith(r)){var i=e.substring((r+"_").length,e.lastIndexOf("."));i=parseInt(i,10),Number.isNaN(i)||(t=Math.max(t,i))}}),t}function getTokenFromRequest(e,r){var i=r.query.token;return i||(i=getTokenFromCookie(e,r)),i}function getTokenFromCookie(e,r){var i=r.cookies;if(!i)return null;for(var t in i)if("wab_auth"===t)try{var n=JSON.parse(i[t]),s=portalUrlUtils.getServerByUrl(n.server)===portalUrlUtils.getServerByUrl(e);if(!s)return null;n.expires=parseInt(n.expires,10);var a=new Date,o=a.getTime(),l=n.expires>o;return l?n.token:null}catch(f){return logger.error(f),null}return null}var path=require("path"),fs=require("fs"),JSZip=new require("jszip"),log4js=require("log4js"),logger=log4js.getLogger("utils"),pako=require("pako"),requirejs=require("requirejs"),portalUrlUtils=requirejs("jimu/shared/basePortalUrlUtils");JSZip.compressions.DEFLATE.compress=function(e){return pako.deflateRaw(e)},exports.zipFolderSync=function(e,r){var i=new JSZip;e=path.normalize(e),visitFolderFiles(e,function(r,t,n){if(n)i.folder(r.substr(e.length,r.length));else{var s;s=fs.readFileSync(r),i.file(r.substr(e.length,r.length),s)}});var t=i.generate({type:"nodebuffer",compression:"DEFLATE"});fs.writeFileSync(r,t,"binary")},exports.unZipToFolderSync=function(e,r){var i=new JSZip(fs.readFileSync(e));fs.existsSync(r)||fs.mkdirSync(r);for(var t in i.files){var n=i.files[t];n.options.dir?fs.mkdirSync(path.join(r,n.name)):fs.writeFileSync(path.join(r,n.name),new Buffer(n._data.getContent()),"binary")}},exports.checkFileExistInZip=function(e,r){var i=new JSZip(fs.readFileSync(e));for(var t in i.files){var n=i.files[t];if(n.name===r)return!0}return!1},exports.visitFolderFiles=visitFolderFiles,exports.visitSubFolders=visitSubFolders,exports.visitObject=visitObject,exports.saveBase64ToImgSync=saveBase64ToImgSync,exports.findMaxFileIndexInFolder=findMaxFileIndexInFolder,exports.getTokenFromRequest=getTokenFromRequest;