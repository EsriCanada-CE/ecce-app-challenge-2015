function importApp(e,r,t){var o=portalUrlUtils.getStandardPortalUrl(e.portalUrl),i=portalUrlUtils.removeProtocol(o);getUniqueAppName(r.appName,r.creator,i,function(o,n){o?(logger.error("get unique app name error."),t(o)):insertAndCopyApp({name:n,description:"",lastUpdated:getCurrentTime(),modified:r.creator,creator:r.creator,portalUrl:i},e,t)})}function insertAndCopyApp(e,r,t){insertToDB(e,function(e,o){return e||0===o.length?void t(e):void copyAppFiles(r,o[0].id,function(e){e?(logger.error("Copy app error:","toApp:",o[0].id,e),deleteFromDB(o[0].id,function(){}),t(e)):t(null,o)})})}function addExtraPropertyOfAppConfig(e,r,t){e.title=r.title,e.isWebTier=r.isWebTier,e.portalUrl=r.portalUrl,e.appId=r.appId,e.map.itemId=r.map.itemId,e.geometryService=r.geometryService,e.httpProxy=r.httpProxy,r.map.mapOptions.extent&&(e.map.mapOptions||(e.map.mapOptions={}),e.map.mapOptions.extent=r.map.mapOptions.extent),t(null,e)}function copyAppFiles(e,r,t){var o,i="./apps/"+r.toString()+"/";if(fse.mkdirsSync(i),"string"==typeof e){if(!(predefinedApps.indexOf(e)>-1))return void fse.copy(getAppPath(e),i,function(e){t(e)});o=fse.readJsonSync(path.join(getAppPath(e),"config.json"))}else o=e;copyFromStemApp(o,r).then(function(){t()},function(e){t(e)})}function copyFromStemApp(e,r){var t=getAppPath(r),o=getAppPath("stemapp"),i=[],n=deferred();return fs.mkdirSync(t+"themes"),fs.mkdirSync(t+"widgets"),i.push(fseCopy(o+"jimu.js",t+"jimu.js")),i.push(fseCopy(o+"images",t+"images")),i.push(fseCopy(o+"libs",t+"libs")),i.push(fseCopy(o+"index.html",t+"index.html")),i.push(fseCopy(o+"env.js",t+"env.js")),i.push(fseCopy(o+"simpleLoader.js",t+"simpleLoader.js")),i.push(fseCopy(o+"init.js",t+"init.js")),i.push(fseCopy(o+"web.config",t+"web.config")),i.push(fseCopy(o+"dynamic-modules",t+"dynamic-modules")),i.push(fseCopy(o+"readme.html",t+"readme.html")),i.push(fseCopy(o+"config-readme.txt",t+"config-readme.txt")),i.push(fseCopy(o+"buildScripts",t+"buildScripts")),i.push(fseCopy(o+".jshintrc",t+".jshintrc")),i.push(fseCopy(o+".jshintignore",t+".jshintignore")),fse.writeJsonSync(t+"config.json",e,"utf-8"),i.push(fseCopy(o+"themes/"+e.theme.name,t+"themes/"+e.theme.name)),sharedUtils.visitElement(e,function(e,t,o){e.widgets||!e.uri||o||i.push(copyWidgetToApp(r,getWidgetNameFromUri(e.uri)))}),deferred.apply(this,i).then(function(e){var r=null;e.forEach(function(e){e&&(r=e)}),r?n.reject(r):n.resolve()}),n.promise}function deleteApp(e,r){try{fse.removeSync(getAppPath(e)),fse.removeSync(getZipFilePath(e)),r()}catch(t){r(t)}}function findApps(e,r,t){e||(e={}),t||(t=[["isTemplate","desc"],["lastUpdated","desc"]]),dbutils.find("apps",e,function(e,t){return e?void r(e,[]):void r(null,t)},{sort:t})}function insertToDB(e,r){dbutils.insert("apps",e,r)}function deleteFromDB(e,r){dbutils.remove("apps",{_id:e},r)}function getCurrentTime(){var e=new Date;return e.valueOf()}function copyWidgetsInConfigToApp(e,r){var t=(getAppPath(e),deferred()),o=[];return sharedUtils.visitElement(r,function(r,t,i){if(!r.widgets&&r.uri&&!i){var n=r.uri.split("/");n.pop();var s=n.pop();o.push(copyWidgetToApp(e,s))}}),deferred.apply(this,o).then(function(){t.resolve()},function(){t.reject()}),t.promise}function copyWidgetToApp(e,r){var t=getAppPath(e),o=deferred();return fs.existsSync(t+"widgets/"+r+"/Widget.js")?(o.resolve(),o.promise):(widgets.getWidgetByName(r,function(i,n){if(i||null===n)logger.warn("copy widget error.",r,i),o.resolve();else try{fse.copySync(n.location,t+"widgets/"+r),logger.info("copy widget",r,"to app",e),o.resolve()}catch(s){o.reject(s)}}),o.promise)}function copyThemeToApp(e,r){var t=getAppPath(e),o=deferred();return fs.existsSync(t+"themes/"+r)?(o.resolve(),o.promise):(themes.getThemeByName(r,function(i,n){return i?(o.reject(Error("Can not find the theme")),o.promise):void fse.copy(n.location,t+"themes/"+r,function(t){return t?(o.reject(t),o.promise):(logger.info("copy theme",r,"to app",e),void o.resolve())})}),o.promise)}function removeThemes(e,r){var t=getAppPath(e),o=deferred();try{var i=fs.readdirSync(t+"themes/");i.forEach(function(o){o!==r.theme.name&&fs.existsSync(t+"themes/"+o)&&(fse.removeSync(t+"themes/"+o),logger.info("remove theme",o,"from app",e))})}catch(n){o.reject(n)}return o.resolve(),o.promise}function removeWidgets(e,r){var t=getAppPath(e),o=deferred();try{var i=fs.readdirSync(t+"widgets");i.forEach(function(o){var i=!1;sharedUtils.visitElement(r,function(e){return!e.widgets&&e.uri&&e.uri.indexOf(o)>-1?(i=!0,!0):void 0}),i?(removeWidgetIcons(t,o,r),removeWidgetConfigs(t,o,r)):(fse.removeSync(t+"widgets/"+o),removeWidgetFolderFromConfigsFolder(t+getConfigsDir(o)),logger.info("remove widget",o,"from app",e))})}catch(n){o.reject(n)}return o.resolve(),o.promise}function removeWidgetIcons(e,r,t){var o=getConfigsDir(r),i=path.join(e,o);fs.existsSync(i)&&fs.readdirSync(i).forEach(function(r){if(r.startWith("icon_")){var o=r.lastIndexOf("."),n=r.substring(5,o),s=!1;sharedUtils.visitElement(t,function(e){return!e.widgets&&e.uri&&e.label===n?(s=!0,!0):void 0}),s||(fse.removeSync(path.join(i,r)),logger.info("remove widget icon",r,"from app configs folder",e))}})}function removeWidgetConfigs(e,r,t){var o=getConfigsDir(r),i=path.join(e,o);fs.existsSync(i)&&fs.readdirSync(i).forEach(function(r){if(r.startWith("config_")){var o=r.substring(7,r.length-5),n=!1;sharedUtils.visitElement(t,function(e){return!e.widgets&&e.uri&&e.label===o?(n=!0,!0):void 0}),n||(fse.removeSync(path.join(i,r)),logger.info("remove widget config",r,"from app configs folder",e))}})}function saveAppLogo(e,r){var t=getAppPath(e),o=deferred();if(r.logo&&r.logo.startWith("data:"))try{var i=utils.saveBase64ToImgSync(path.join(t,"images/logo.png"),r.logo);r.logo=i.substr(path.join(t).length),o.resolve()}catch(n){o.reject(n)}else o.resolve();return o.promise}function saveWidgetsIcon(e,r){var t=getAppPath(e),o=deferred();return sharedUtils.visitElement(r,function(e){if(e.uri){var r,i=getWidgetNameFromUri(e.uri),n=getConfigsDir(i),s=null;if(e.icon&&e.icon.startWith("data:")){s=e.icon,r="icon_"+e.label+".png";try{var p=saveWidgetImageToConfigsFolder(path.join(t,n),r,s);e.icon=p.substr(path.join(t).length)}catch(a){o.reject(a)}}}}),o.resolve(),o.promise}function saveWidgetsConfig(e,r){var t=getAppPath(e),o=deferred(),i=[];return sharedUtils.visitElement(r,function(e){if(e.uri){var r,n=getConfigsDir(e.name),s=path.join(t,n),p=null;if(e.config&&"object"==typeof e.config){r="config_"+e.label+".json",p=e.config,e.config=n+r;try{processWidgetConfig(t,n,p),i.push(saveWidgetConfigToConfigsFolder(s,r,p))}catch(a){o.reject(a)}}}}),0===i.length?o.resolve():deferred.apply(this,i).then(function(){o.resolve()},function(e){o.reject(e)}),o.promise}function processWidgetConfig(e,r,t){utils.visitObject(t,function(t,o){/^data:image\/.*;base64,/.test(t[o])&&saveBase64ImageToConfigsFolderAndChangeAppConfig(e,r,t,o)})}function saveBase64ImageToConfigsFolderAndChangeAppConfig(e,r,t,o){var i=path.join(e,r);if(fs.existsSync(i)||fse.mkdirsSync(i),!/^data:image\/(png|jpeg|bmp|gif);base64,/.test(t[o]))throw Error("wrong image format.");var n,s=utils.findMaxFileIndexInFolder(i,o);n=-1===s?o+".png":o+"_"+(s+1)+".png";var p=utils.saveBase64ToImgSync(path.join(i,n),t[o]);t[o]="${appPath}/"+path.join(r,p.substr(path.join(i).length)),t[o]=t[o].replace(/\\/g,"/")}function saveAppConfig(e,r){var t=getAppPath(e);return fseWriteJson(t+"config.json",r)}function getAppPath(e){return e+="","stemapp"===e?"../client/stemapp/":predefinedApps.indexOf(e)>-1?path.join("../client/builder/predefined-apps/",e,"/"):path.join("./apps/",e,"/")}function getZipFilePath(e){return"./apps/zips/"+e+".zip"}function getAGOLZipFilePath(e){return"./apps/zips/"+e+"AGOLTemplate.zip"}function getWidgetNameFromUri(e){var r=e.split("/");return r.pop(),r.pop()}function getWidgetsDirFromUri(e){var r=e.split("/");return r.pop(),r.join("/")}function getConfigsDir(e){var r="configs/"+e+"/";return r}function saveWidgetConfigToConfigsFolder(e,r,t){return fs.existsSync(e)||fse.mkdirsSync(e),fseWriteJson(path.join(e,r),t)}function saveWidgetImageToConfigsFolder(e,r,t){return fs.existsSync(e)||fse.mkdirsSync(e),utils.saveBase64ToImgSync(path.join(e,r),t)}function removeWidgetFolderFromConfigsFolder(e){fs.existsSync(e)&&fse.removeSync(e)}function zipApp(e,r){var t=getAppPath(e);t=path.normalize(t);try{fs.existsSync("./apps/zips")||fs.mkdirSync("./apps/zips");var o=fse.readJsonSync(path.join(getAppPath(e),"config.json")),i=o.portalUrl;"/"!==i.substr(i.length-1,i.length)&&(i+="/");var n="//js.arcgis.com/3.12",s=new JSZip;utils.visitFolderFiles(t,function(e,r,o){var i,p=e.substr(t.length,e.length);if(o)s.folder(p);else if("env.js"===p)i=fs.readFileSync(e,{encoding:"utf-8"}),i=i.replace("//apiUrl=[POINT_TO_ARCGIS_API_FOR_JAVASCRIPT];",'apiUrl = "'+n+'";'),s.file(p,i);else if("config.json"===p){var a=fse.readJsonSync(e);a.httpProxy={useProxy:!0,alwaysUseProxy:!1,url:"",rules:[]},a.appId="",s.file(p,JSON.stringify(a))}else i=fs.readFileSync(e),s.file(p,i)});var p=s.generate({type:"nodebuffer",compression:"DEFLATE"});fs.writeFileSync(getZipFilePath(e),p,"binary"),r()}catch(a){console.log(a),r(a)}}function unZipApp(e){var r=getAppPath(e);r=path.normalize(r);try{utils.unZipToFolderSync(getZipFilePath(e),r)}catch(t){return console.log(t),!1}return!0}function zipAGOLApp(e,r,t){try{var o=new JSZip;fs.existsSync("./apps/zips")||fs.mkdirSync("./apps/zips"),o.file(t+".zip",fs.readFileSync(e)),o.file("AGOLTemplate.json",r);var i=o.generate({type:"nodebuffer",compression:"STORE"});fs.writeFileSync(path.normalize(getAGOLZipFilePath(t)),i,"binary")}catch(n){return console.log(n),!1}return!0}function readAppConfig(e){return fse.readJsonSync(path.join(getAppPath(e),"config.json"))}function findMaxNumFromSameNameApps(e){var r,t,o,i,n=0;for(r=0;r<e.length;r++)i=e[r].name,t=i.search(/\_copy-/)+6,o=Number(i.slice(t,i.length)),o>n&&(n=o);return n++,n}function getUniqueAppName(e,r,t,o){var i,n,s;n=e.replace(/\_copy-[0-9]+/,"");var p=new RegExp("^"+n+"(_copy-[0-9])*");findApps({name:p,creator:r,portalUrl:t},function(r,t){r?(logger.error("find app failed in getUniqueAppName!"),o(r)):(0===t.length?s=e:(i=findMaxNumFromSameNameApps(t),s=n+"_copy-"+i),o(r,s))},[["name","desc"]])}function getAppById(e,r){dbutils.find("apps",{_id:e},function(e,t){return e?void r(e,null):t.length<1?void r(null,null):void r(null,t[0])})}var deferred=require("deferred"),fs=require("fs"),path=require("path"),themes=require("./themes"),widgets=require("./widgets"),repo=require("./repo"),fse=require("fs-extra"),utils=require("../utils"),dbutils=require("../dbutils"),JSZip=new require("jszip"),request=require("request"),requirejs=require("requirejs"),sharedUtils=requirejs("jimu/shared/utils"),portalUrlUtils=requirejs("jimu/shared/basePortalUrlUtils"),versionManager=require("./version-manager"),fseCopy=deferred.promisify(fse.copy),fseWriteJson=deferred.promisify(fse.writeJson),log4js=require("log4js"),logger=log4js.getLogger("app"),predefinedApps=fs.readdirSync("../client/builder/predefined-apps/");exports.getAppList=function(e,r){var t=portalUrlUtils.getStandardPortalUrl(e.query.portalUrl);findApps({creator:e.query.username,portalUrl:portalUrlUtils.removeProtocol(t)},function(e,t){e?(logger.error("getAppList failed!"),r.send({success:!1})):r.send(t)})},exports.getApp=function(e,r){var t=e.params.appId;findApps({_id:t},function(e,t){e?(logger.error("getAppfailed!"),r.send({success:!1})):(logger.debug("getApp successfully."),r.send(t[0]))})},exports.saveAppConfig=function(e,r){var t=e.params.appId;if(!t)return void r.send({success:!1,message:"No appId"});var o=JSON.parse(e.body.appConfig),i=removeThemes(t,o),n=removeWidgets(t,o),s=copyThemeToApp(t,o.theme.name),p=copyWidgetsInConfigToApp(t,o),a=saveAppLogo(t,o),d=saveWidgetsIcon(t,o),c=saveWidgetsConfig(t,o);deferred(i,n,s,p,a,d,c).then(function(){return saveAppConfig(t,o)}).then(function(){fs.existsSync(getZipFilePath(t))&&fs.unlinkSync(getZipFilePath(t)),dbutils.update("apps",{_id:t},{$set:{lastUpdated:getCurrentTime(),modified:e.body.modified}},function(e,t){e||1!==t?(console.error("update app's lastUpdateTime error when saveAppConfig"),r.send({success:!1,message:e.message})):r.send({success:!0})})},function(e){r.send({success:!1,message:e.message})})},exports.copyWidgetToApp=function(e,r){var t=e.params.appId,o=e.body.widgetName;copyWidgetToApp(t,o).then(function(){r.send({success:!0})},function(e){r.send({success:!1,message:e})})},exports.copyThemeToApp=function(e,r){var t=e.params.appId,o=e.body.themeName,i=JSON.parse(e.body.layoutConfig),n=[];n.push(copyThemeToApp(t,o)),i.theme={name:o},sharedUtils.visitElement(i,function(e,r,o){if(!e.widgets&&e.uri&&!o){var i=e.uri.split("/");i.pop();var s=i.pop();n.push(copyWidgetToApp(t,s))}}),deferred.apply(this,n).then(function(){r.send({success:!0})},function(e){r.send({success:!1,message:e})})},exports.download=function(e,r){var t=e.params.appId,o=getZipFilePath(t);findApps({_id:t},function(e,i){if(e)r.send({success:!1});else{var n=i[0].name;fs.existsSync(o)?r.download(o,n+".zip"):zipApp(t,function(e){e?r.send({success:!1}):r.download(o,n+".zip")})}})},exports.checkAppVersion=function(e,r){var t=JSON.parse(e.body.appConfig);try{var o=versionManager.getAppVersion(t);r.send({success:!0,versionInfo:o})}catch(i){r.send({success:!1,message:i.message})}},exports.importApp=function(e,r){var t=JSON.parse(e.body.appConfig);delete t._buildInfo,t.httpProxy&&t.httpProxy.url&&(t.httpProxy.url="/proxy.js");try{var o=versionManager.getAppVersion(t);if("old"===o.wabVersionStatus)try{versionManager.upgradeAppConfig(t)}catch(i){return logger.error("Upgrade app error:",i),void r.send({success:!1,message:"Error occur when upgrading app config."})}else if("new"===o.wabVersionStatus)return void r.send({success:!1,message:"The app is created by newer WAB version."});importApp(t,JSON.parse(e.body.appInfo),function(e,t){return e?(console.error("fail to import app.",e),void r.send({success:!1,message:"Fail to import app."})):void r.send({success:!0,appId:t[0]._id})})}catch(i){r.send({success:!1,message:i.message})}},exports.updateApp=function(e,r){findApps({name:e.body.name,creator:e.body.creator,portalUrl:portalUrlUtils.removeProtocol(e.body.portalUrl)},function(t,o){if(t)return logger.error("Find app error when update app."),void r.send({success:!1,message:"Find app error when update app."});if(1===o.length&&o[0].id.toString()!==e.body.id.toString())return r.send({success:!1,message:"An app '"+e.body.name+"' exists already. Please choose another name."}),void logger.error("App exists. Name: "+e.body.name);var i=getCurrentTime();dbutils.update("apps",{_id:e.body.id},{$set:{name:e.body.name,description:e.body.description,lastUpdated:i,modified:e.body.modified}},function(t,o){1!==o?(logger.error("updateApp error"),r.send({success:!1})):r.send({success:!0,lastUpdated:i,modified:e.body.modified})})})},exports.updateAgolTemplateInApp=function(e,r){dbutils.update("apps",{_id:e.body.id},{$set:{agolTemplateInfo:JSON.parse(e.body.agolTemplateInfo)}},function(t,o){1!==o?(logger.error("Error occurs when updating AGOL template info in App."),r.send({success:!1})):(fs.existsSync(getAGOLZipFilePath(e.body.id))&&fs.unlinkSync(getAGOLZipFilePath(e.body.id)),r.send({success:!0}))})},exports.createApp=function(e,r){var t="true"===e.body.is3D?"default3DApp":"default2DApp",o=portalUrlUtils.removeProtocol(e.body.portalUrl);findApps({name:e.body.name,creator:e.body.creator,portalUrl:o},function(i,n){return i?(logger.error("Find app error when creating app."),void r.send({success:!1,message:"Find app error when creating app."})):n.length>0?(r.send({success:!1,message:"An app '"+e.body.name+"' exists already. Please choose another name."}),void logger.error("App exists. Name: "+e.body.name)):void insertAndCopyApp({name:e.body.name,description:e.body.description,lastUpdated:getCurrentTime(),is3D:e.body.is3D,creator:e.body.creator,modified:e.body.creator,portalUrl:o},t,function(t,o){return t?(logger.error("create app failed! name:",e.body.name),void r.send({success:!1,message:"Failed to create new app."})):void addExtraPropertyOfAppConfig(readAppConfig(o[0].id),JSON.parse(e.body.extraPropertyOfAppConfig),function(e,t){return e?(logger.error("Add setting value error."),void r.send({success:!1,message:"Add setting value error."})):void saveAppConfig(o[0].id,t).then(function(){r.send({success:!0,newAppId:o[0].id,apps:{}})},function(){r.send({success:!1,message:"Failed to create new app. add setting failed."})})})})})},exports.removeApp=function(e,r){deleteFromDB(e.body.id,function(t,o){return 1!==o?(logger.warn("App removed already",e.body.id),void r.send({success:!0})):void deleteApp(e.body.id,function(t){t?(logger.error("Remove app failed, unable to remove app files. id:",e.body.id),r.send({success:!1,message:"Unknown error when delete app."})):(logger.info("App removed, id:",e.body.id),r.send({success:!0}))})})},exports.duplicateApp=function(e,r){var t=portalUrlUtils.removeProtocol(e.body.portalUrl);getUniqueAppName(e.body.name,e.body.creator,t,function(o,i){o?(logger.error("Get app name error."),r.send({success:!1,message:"Failed to duplicate app."})):insertAndCopyApp({name:i,description:e.body.description,lastUpdated:getCurrentTime(),is3D:e.body.is3D,creator:e.body.creator,modified:e.body.creator,portalUrl:t},e.body.id,function(t,o){t?(logger.error("Duplicate app failed, app name:",e.body.name),r.send({success:!1})):(logger.info("Duplicate app",e.body.name,"to",i),r.send({success:!0,newAppId:o[0].id,newName:i}))})})},exports.downloadAGOLTemplate=function(e,r){var t=e.params.appId,o=getZipFilePath(t),i=getAGOLZipFilePath(t);findApps({_id:t},function(e,n){if(e)return void console.error("find app failed when download AGOL template: "+e);var s=n[0],p=JSON.parse(s.agolTemplateJson);p.configurationSettings.forEach(function(e){delete e.categoryName,e.fields.forEach(function(e){delete e.id})}),fs.existsSync(i)?r.download(i):fs.existsSync(o)?(zipAGOLApp(o,JSON.stringify(p),t),r.download(i,s.name+"_AGOLTemplate.zip")):zipApp(t,function(e){e?r.send({success:!1}):zipAGOLApp(o,JSON.stringify(p),t)?r.download(i,s.name+"_AGOLTemplate.zip"):r.send({success:!1})})})};